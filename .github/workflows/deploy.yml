name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            echo "Starting deployment..."
            
            # Navigate to project directory (update this path to your actual server path)
            # Based on your session, you were in /root or home directory.
            # We will attempt to verify where 'vedium' folder is.
            
            TARGET_DIR=""
            if [ -d "/opt/vedium" ]; then
                TARGET_DIR="/opt/vedium"
            elif [ -d "/root/vedium" ]; then
                TARGET_DIR="/root/vedium"
            elif [ -d "$HOME/vedium" ]; then
                TARGET_DIR="$HOME/vedium"
            else
                # Fallback: find it
                TARGET_DIR=$(find / -type d -name "vedium" -maxdepth 3 2>/dev/null | head -n 1)
            fi

            if [ -z "$TARGET_DIR" ]; then
                echo "Error: Could not find 'vedium' directory on server."
                exit 1
            fi

            echo "Deploying in $TARGET_DIR"
            cd "$TARGET_DIR"
            
            # Pull changes on Host
            git pull origin main

            # Update inside container (Critical for Frappe which often has its own git state)
            CONTAINER="vedium-frappe"
            
            echo "Updating vedium_core inside container..."
            # Since volume mount might be missing or different, we force copy the updated code
            docker cp vedium_core $CONTAINER:/home/frappe/frappe-bench/apps/
            docker exec -u 0 $CONTAINER chown -R frappe:frappe /home/frappe/frappe-bench/apps/vedium_core
            
            # Ensure package is installed
            docker exec -w /home/frappe/frappe-bench $CONTAINER pip install -e apps/vedium_core

            # Run Bench Commands
            echo "Running bench commands..."
            SITE_NAME="app.vediums.com"
            docker exec -w /home/frappe/frappe-bench $CONTAINER bench --site $SITE_NAME install-app vedium_core || echo "App already installed"
            docker exec -w /home/frappe/frappe-bench $CONTAINER bench --site $SITE_NAME migrate
            
            # Force copy assets (Bypass bench build due to server memory constraints)
            echo "Copying assets..."
            docker exec $CONTAINER cp /home/frappe/frappe-bench/apps/vedium_core/vedium_core/public/css/vedium.css /home/frappe/frappe-bench/sites/assets/vedium_core/css/vedium.css || echo "CSS copy failed"
            docker exec $CONTAINER cp -r /home/frappe/frappe-bench/apps/vedium_core/vedium_core/public/images/* /home/frappe/frappe-bench/sites/assets/vedium_core/images/ || echo "Images copy failed"

            docker exec -w /home/frappe/frappe-bench $CONTAINER bench --site $SITE_NAME clear-cache

            echo "Deployment finished."
